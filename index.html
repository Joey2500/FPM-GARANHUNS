<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>C√°lculo do FPM</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet" />
    <style>
        /* IN√çCIO DO ESTILO */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 10px;
            background: #8C2D2D;
            color: #000000;
            font-size: 14px;
            font-weight: 700;
        }
        .topbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            color: #FFFFFF;
        }
        .download-btn {
            padding: 10px 15px;
            font-size: 14px;
            border-radius: 0;
            background: #D9C6A5;
            color: #000000;
            border: 2px solid #000000;
            cursor: pointer;
            font-weight: 700;
            box-shadow: 4px 4px 0px #000000;
            transition: all 0.15s ease-out;
        }
        .download-btn:hover {
            background: #4A2A20;
            color: #D9C6A5;
            box-shadow: 2px 2px 0px #000000;
            transform: translate(2px, 2px);
        }
        .date-time {
            flex-grow: 1;
            font-style: normal;
            color: #FFFFFF;
            font-size: 14px;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #D9C6A5;
            padding: 15px;
            border-radius: 0;
            border: 3px solid #000000;
            box-shadow: 10px 10px 0px #000000;
        }
        .date-time-pdf {
            font-size: 12px;
            color: #000000;
            margin-bottom: 8px;
        }
        .logo {
            text-align: center;
        }
        .logo img {
            width: 120px;
            height: auto;
            margin-bottom: 10px;
        }
        .logos-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0 20px;
            margin-bottom: 15px;
            min-height: 120px; /* Altura m√≠nima para posicionamento vertical */
        }
        .logos-container .logo:last-child {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }
        .highlight {
            text-align: center;
            background: #4A2A20;
            color: #D9C6A5;
            border-radius: 0;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #000;
        }
        .highlight .title-wide {
            font-size: 24px;
            font-weight: 900;
            text-transform: uppercase;
        }
        .highlight .subtitle {
            font-size: 18px;
            font-weight: 700;
            opacity: 1;
        }
        .multiplier {
            margin-top: 12px;
            border-left: none;
            border: 2px solid #000;
            background: #FFFFFF;
            padding: 10px 15px;
            border-radius: 0;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .multiplier input {
            font-size: 15px;
            border: none;
            text-align: right;
            background: transparent;
            width: 100px;
            font-weight: 700;
        }
        .data-box,
        .deductions {
            margin-top: 12px;
            background: #FFFFFF;
            padding: 10px 15px;
            border-radius: 0;
            box-shadow: none;
            border: 2px solid #000;
        }
        .data-box.yellow {
            background: #EFE1C5;
        }
        .data-box.green {
            background: #A88F71;
            color: #fff;
        }
        .data-row {
            display: grid;
            grid-template-columns: 1fr auto;
            padding: 6px 0;
            font-size: 15px;
        }
        input.edit {
            border: none;
            background: transparent;
            font-size: 15px;
            text-align: right;
            width: 100%;
            font-weight: 700;
        }
        input.edit:focus {
            outline: 2px solid #000;
            background: #f0f0f0;
        }
        .blue-section {
            background: #8C2D2D;
            color: #D9C6A5;
            padding: 20px;
            margin-top: 20px;
            border-radius: 0;
            text-align: center;
            border: 2px solid #000;
        }
        .blue-section input {
            background: transparent;
            border: none;
            border-bottom: 2px solid #D9C6A5;
            width: 40px;
            font-size: 18px;
            font-weight: 900;
            color: #D9C6A5;
            text-align: center;
        }
        .blue-section .label {
            margin: 0 5px 0 15px;
        }
        .blue-section #resultadoMultiplicacao {
            font-size: 2.5em;
            font-weight: 900;
            color: #000000;
            background: none;
            padding: 10px 20px;
            border-radius: 0;
            box-shadow: none;
            letter-spacing: 1px;
            display: block;
            margin-top: 10px;
            border: 2px solid #000;
            background-color: #D9C6A5;
        }
        .blue-section #resultadoMultiplicacao:hover {
            transform: none;
        }
        .liquid {
            margin-top: 12px;
            padding: 15px;
            background: #000000;
            color: #D9C6A5;
            font-weight: 700;
            text-align: center;
            font-size: 18px;
            border: 2px solid #000;
        }
        .chart-container {
            margin-top: 30px;
            padding: 10px;
            border: 2px solid #000;
            background-color: #fff;
        }
        canvas#grafico {
            max-width: 100%;
            height: 350px !important;
        }
        .logo-footer {
            text-align: center;
            background-color: #4A2A20;
            color: #D9C6A5;
            padding: 20px;
            border-radius: 0;
            font-size: 17px;
            margin-top: 20px;
            border: 3px solid #000;
            box-shadow: 8px 8px 0 #8C2D2D;
        }
        .logo-footer img {
            width: 100px;
            margin-bottom: 4px;
        }
        .logo-footer .footer-text {
            font-weight: 500;
        }
        .logo-footer .footer-text strong {
            color: #FFFFFF;
        }
        #tela-senha {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .caixa-senha {
            background: #D9C6A5;
            padding: 30px;
            border: 3px solid #000;
            box-shadow: 10px 10px 0px #000000;
            text-align: center;
        }
        .caixa-senha h2 {
            margin: 0 0 15px 0;
            font-size: 20px;
            color: #4A2A20;
        }
        .caixa-senha input {
            padding: 10px;
            font-size: 16px;
            border: 2px solid #000;
            margin-bottom: 15px;
            width: 200px;
            text-align: center;
        }
        .caixa-senha button {
            width: 100%;
        }
        #mensagem-erro {
            color: #8C2D2D;
            font-weight: bold;
            margin-top: 10px;
            min-height: 20px;
        }
        .abas-container {
            display: flex;
            margin-bottom: 15px;
        }
        .aba {
            padding: 10px 20px;
            cursor: pointer;
            border: 2px solid #000;
            background-color: #EFE1C5;
            color: #000;
            font-weight: 700;
            font-size: 16px;
            border-bottom: none;
        }
        .aba.active {
            background-color: #00A8A8;
            color: #000;
        }
        .conteudo-aba {
            display: none;
            padding-top: 10px;
        }
        .conteudo-aba.active {
            display: block;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4A2A20;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #graficos-historico-container canvas {
            max-width: 100%;
            height: 250px !important;
        }
         @media (min-width: 768px) {
            #graficos-historico-container {
                /* For more than one chart, use grid */
                /* grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); */
            }
        }
    </style>
</head>
<body>

    <div id="tela-senha">
        <div class="caixa-senha">
            <h2>Acesso Restrito</h2>
            <input type="password" id="campo-senha" placeholder="Digite a senha">
            <button onclick="verificarSenha()" class="download-btn">ENTRAR</button>
            <div id="mensagem-erro"></div>
        </div>
    </div>

    <div id="conteudo-protegido" style="display: none;">

        <div class="topbar">
            <div class="date-time" id="dataHoraTela"></div>
            <button onclick="baixarPNG()" class="download-btn">üì• BAIXAR PNG</button>
        </div>

       <div class="container">
            <div class="abas-container">
                <button class="aba active" onclick="mostrarAba('calculadora', this)">Calculadora FPM</button>
                <button class="aba" onclick="mostrarAba('historico', this)">Hist√≥rico</button>
            </div>
			
            <div id="calculadora" class="conteudo-aba active">
                <!-- Conte√∫do da Calculadora -->
                <div class="date-time-pdf">üìÖ Emitido em: <span id="dataHoraPdf"></span></div>

                <div class="logos-container">
                    <div class="logo"><img src="data:image/png;base64,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Me8jzns5/9LHPz88yMjHH69Gnm5+dRFBXt8t0YGRnhpZde4qSTTiJJEi+99BLve9/7WL58Oa997WvZvn07ZWVl3HTTTXzqU59qNBoVF0VRhLfffpslS5bwu9/9jttvv50HHniA5cuX85nPfIZvf/vbpW0DAwP87ne/Y2pqitdeey1f+tKXOHbsGE888QS/+MUvmJubI8syFEXhzDPP5H/+538A/e73v8/f//3fefPNN5menubcc8/ls5/9LCtXruTo0aN89KMf5de//nVGR0c5ePAgb33rW5mamuLNb34zP/vZz1i8eDFf+tKX+M//+T+cOXMGpRSf+9zn+PSnP823vvUtvvGNb5RlWWm1v/nNb3L69GmWLVvGVVddxa233sqFF15ImqY8//zznD9/nlNPPZX/+I//wN/+7d9SSnG9731vWW6b5t/+7d9yww038MY3vpE0TWmaJssyvvSlL3HWWWdxzTXX8O1vf5v9+/fz4x//mFe84hXccMMN5Y99yVvf+layLGNycjK/+MUvmJiY4JNPPmF2dpZbbrmFRx99lJ/+9KfMnz+fuXPnMnPmTP74xz9y/Phxmpqa+O53v8tvfvMbXv7yl3Pss89mYmKCm266id/+9rfs2rWL//mf/8mll17KO97xDr7xjW+c+T2L48L5k1/8In/913/N7//+7/nyF7/Iddddx9e//nW++93v8oUvfIFzzjmH173udTz00EPF5dK3c3n2s5/lvffeY+XKlaz+3XexYsUKXvjCF3L55ZeX6304tJSUvB4E/7eWl/8AAAAAElFTkSuQmCC" alt="Logo Prefeitura de Garanhuns" style="width: 100px;"></div>
                    <div class="logo">
                        <img src="data:image/png;base64,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" alt="Logo Cespam">
                        <div class="Logo-text"><strong>Compet√™ncia em Gest√£o Municipal</strong></div>
                    </div>
                </div>

                <div class="highlight">
                    <div class="title-wide">PREFEITURA MUNICIPAL</div>
                    <div class="subtitle" id="subtitle">Garanhuns</div>
                </div>
            
                <div class="multiplier">
                    FATOR DE MULTIPLICA√á√ÉO:
                    <input type="text" id="multiplicador" class="edit" value="0.0000">
                </div>
            
                <div class="data-box yellow">
                    <div class="data-row">
                        <span>3¬™ Cota ‚Äì Valor Bruto</span>
                        <input id="valorBrutoAnterior" class="edit" value="0,00">
                    </div>
                </div>
            
                <div class="data-box green">
                    <div class="data-row">
                        <span>Cota equivalente ‚Äì Valor L√≠quido</span>
                        <input id="valorLiquidoAnterior" class="edit" value="0,00">
                    </div>
                    <div class="data-row">
                        <span>Cota equivalente ‚Äì Valor Bruto</span>
                        <input id="valorBrutoEquivalente" class="edit" value="0,00">
                    </div>
                    <div class="data-row">
                        <span>√çndice de Repasse</span>
                        <span id="pesoPercentualFormatted">0,00%</span>
                    </div>
                </div>
            
                <div class="blue-section">
                    <strong>COTA N¬∫</strong>
                    <input id="cotaNumero" class="edit" value="00">
                    <span class="label">M√äS</span>
                    <input id="cotaMes" class="edit" value="00">
                    <span class="label">ANO</span>
                    <input id="cotaAno" class="edit" value="00">
                    <br><br>
                    <span style="font-size:1.5em;font-weight:bold;font-family:'Roboto',sans-serif;">
                        üí∞ VALOR BRUTO:
                    </span>
                    <span id="resultadoMultiplicacao">-</span>
                </div>
            
                <div class="deductions">
                    <div class="data-row"><span>PASEP 1%</span><span id="deducaoPasep">0,00</span></div>
                    <div class="data-row"><span>SA√öDE 15%</span><span id="deducaoSaude">0,00</span></div>
                    <div class="data-row"><span>FUNDEB 20%</span><span id="deducaoFundeb">0,00</span></div>
                    <div class="data-row">
                        <span>Parcelamento RFB</span>
                        <input id="parcelamentoRfb" class="edit" value="0,00" style="width:80px">
                    </div>
                    <div class="data-row">
                        <strong>TOTAL DEDU√á√ïES</strong>
                        <strong id="totalDeducoes">0,00</strong>
                    </div>
                </div>
            
                <div class="liquid" style="margin-bottom: 20px;">
                    PREVIS√ÉO L√çQUIDA - FPM: <span id="previsaoLiquida">0,00</span>
                </div>

                <div id="gemini-analysis-container" style="margin-bottom: 20px;">
                    <button onclick="gerarAnaliseGemini()" class="download-btn" style="width: 100%;">
                        ‚ú® OBTER AN√ÅLISE COM IA
                    </button>
                    <div id="gemini-loading" style="display: none; text-align: center; margin-top: 15px;">
                        <div class="spinner" style="margin: 0 auto 10px;"></div>
                        <p style="font-weight: bold; color: #4A2A20;">Analisando dados...</p>
                    </div>
                    <div id="gemini-result-box" style="display: none; margin-top: 15px; padding: 15px; background: #EFE1C5; border: 2px solid #000;">
                        <h3 style="margin: 0 0 10px 0; color: #4A2A20; font-size: 16px;">An√°lise Financeira ‚ú®</h3>
                        <p id="gemini-result-text" style="font-size: 15px; line-height: 1.6;"></p>
                    </div>
                </div>

                <button onclick="salvarNoHistorico()" class="download-btn" style="width: 100%; margin-bottom: 20px;">
                    SALVAR C√ÅLCULO NO HIST√ìRICO
                </button>

                <div class="grafico-legenda" style="text-align:center; font-size:16px; font-weight:bold; color:#000; margin:10px 0 10px;">
                    Comparativo entre o valor bruto do m√™s anterior e do m√™s atual
                </div>
                <div class="chart-container">
                    <canvas id="grafico"></canvas>
                </div>
            </div>
            <div id="historico" class="conteudo-aba">
                <h2 style="color: #4A2A20;">Hist√≥rico de C√°lculos</h2>
                <div id="analise-historico-container" style="margin-bottom: 15px;"></div>
                
                <!-- Container dos Gr√°ficos de Hist√≥rico -->
                <div id="graficos-historico-container" style="display: none; display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 25px;">
                    <div class="chart-container" style="margin-top:0; padding: 15px;">
                        <canvas id="grafico-bruto-historico"></canvas>
                    </div>
                    <div class="chart-container" style="margin-top:0; padding: 15px;">
                        <canvas id="grafico-deducoes-historico"></canvas>
                    </div>
                    <div class="chart-container" style="margin-top:0; padding: 15px;">
                        <canvas id="grafico-liquido-historico"></canvas>
                    </div>
                </div>

                <div id="historico-conteudo">
                    <p>Nenhum c√°lculo salvo ainda.</p>
                </div>
                 <button onclick="limparHistorico()" class="download-btn" style="background-color: #8C2D2D; color: #D9C6A5; margin-top: 15px;">Limpar Hist√≥rico</button>
            </div>
        </div>

        <div class="logo-footer">
            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT6-6A-i5e3gI_o-W1vjWp-M8ZJ9E1YjB-sQ&s" alt="Logo CESPAM">
            <div class="footer-text"><strong>Sistema desenvolvido pelo CESPAM</strong> - Reprodu√ß√£o por Terceiros Proibida¬Æ</div>
        </div>
    </div>

    <div id="modal-fundo" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 10000; align-items: center; justify-content: center;">
        <div id="modal-caixa" style="background: #fff; border: 3px solid #000; padding: 25px; text-align: center; box-shadow: 8px 8px 0 #000;">
            <p id="modal-mensagem" style="font-size: 16px; margin-bottom: 20px; line-height: 1.6;"></p>
            <div id="modal-botoes"></div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        const el = id => document.getElementById(id);
        const val = id => el(id).value;

        // ===================================================================================
        // IMPORTANTE: Para a an√°lise com IA funcionar, voc√™ precisa de uma chave da API
        // do Google Gemini. Obtenha uma gratuitamente no Google AI Studio e cole aqui.
        // ===================================================================================
        const GEMINI_API_KEY = "AIzaSyCywncl_7WRMhHXWLkMjChhYDUMKN7YnO4"; 
        // ===================================================================================
        
        let graficoBrutoHistorico, graficoDeducoesHistorico, graficoLiquidoHistorico;

        // --- FUN√á√ÉO DE VERIFICA√á√ÉO DE SENHA ---
        function verificarSenha() {
            const SENHA_CORRETA = 'Cespam10';
            const senhaDigitada = val('campo-senha');
            const mensagemErro = el('mensagem-erro');
            if (senhaDigitada === SENHA_CORRETA) {
                el('tela-senha').style.display = 'none';
                el('conteudo-protegido').style.display = 'block';
            } else {
                mensagemErro.textContent = 'Senha incorreta. Tente novamente.';
                el('campo-senha').value = '';
            }
        }
        el('campo-senha').addEventListener('keyup', e => e.key === 'Enter' && verificarSenha());

        // --- C√ìDIGO DAS ABAS ---
        function mostrarAba(idAba, elementoAba) {
            document.querySelectorAll('.conteudo-aba').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.aba').forEach(a => a.classList.remove('active'));
            el(idAba).classList.add('active');
            elementoAba.classList.add('active');
        }
        
        // --- MODAL PERSONALIZADO ---
        function mostrarModal(mensagem, tipo = 'alert', callbackConfirm = null) {
            el('modal-mensagem').innerHTML = mensagem;
            const botoesContainer = el('modal-botoes');
            botoesContainer.style.display = 'block';
            if (tipo === 'confirm') {
                botoesContainer.innerHTML = `
                    <button id="modal-btn-confirma" class="download-btn">Sim</button>
                    <button id="modal-btn-cancela" class="download-btn" style="background-color: #8C2D2D; color: #D9C6A5; margin-left: 10px;">N√£o</button>
                `;
                el('modal-btn-confirma').onclick = () => {
                    if (callbackConfirm) callbackConfirm();
                    fecharModal();
                };
                el('modal-btn-cancela').onclick = fecharModal;
            } else {
                botoesContainer.innerHTML = '<button id="modal-btn-ok" class="download-btn">OK</button>';
                el('modal-btn-ok').onclick = fecharModal;
            }
            el('modal-fundo').style.display = 'flex';
        }

        function fecharModal() {
            el('modal-fundo').style.display = 'none';
        }

        // --- GEMINI API FEATURES ---
        async function callGeminiApi(prompt, useSearch = false) {
            const loadingIndicator = el('gemini-loading');
            const resultBox = el('gemini-result-box');
            const resultText = el('gemini-result-text');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            
            loadingIndicator.style.display = 'block';
            resultBox.style.display = 'none';
            resultText.innerHTML = '';

            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            if (useSearch) {
                payload.tools = [{ "google_search": {} }];
            }
            
            let response;
            let retries = 3;
            let delay = 1000;

            while (retries > 0) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            loadingIndicator.style.display = 'none';
                            resultText.innerHTML = candidate.content.parts[0].text.replace(/\n/g, '<br>');
                            resultBox.style.display = 'block';
                            return; 
                        }
                    }
                } catch (error) {
                    console.error("Fetch error:", error);
                }
                retries--;
                if (retries > 0) await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
            }
            loadingIndicator.style.display = 'none';
            resultText.innerHTML = 'N√£o foi poss√≠vel gerar a an√°lise. Verifique sua chave da API e tente novamente.';
            resultBox.style.display = 'block';
        }

        function gerarAnaliseGemini() {
            const cotaNum = val('cotaNumero');
            const cotaMes = val('cotaMes');
            const cotaAno = val('cotaAno');
            const valorBrutoAnterior = val('valorBrutoAnterior');
            const valorBrutoEquivalente = val('valorBrutoEquivalente');
            const valorBrutoResultado = el('resultadoMultiplicacao').textContent;
            const totalDeducoes = el('totalDeducoes').textContent;
            const previsaoLiquida = el('previsaoLiquida').textContent;
            const municipio = el('subtitle').textContent || 'Garanhuns';

            if (previsaoLiquida === '0,00' || previsaoLiquida === '-') {
                mostrarModal('Calcule um valor antes de solicitar a an√°lise.');
                return;
            }
            if (GEMINI_API_KEY === "COLE_SUA_CHAVE_API_AQUI") {
                 mostrarModal('Por favor, adicione sua chave da API do Google Gemini no c√≥digo para usar esta funcionalidade.');
                 return;
            }
            const prompt = `Aja como um analista financeiro especialista em contas p√∫blicas municipais no Brasil. Para o munic√≠pio de ${municipio}, o c√°lculo da ${cotaNum}¬™ cota do FPM do m√™s ${cotaMes}/${cotaAno} apresentou os seguintes dados:\n- Valor Bruto da Cota Anterior (base para o fator): R$ ${valorBrutoAnterior}\n- Valor Bruto da Cota Equivalente (m√™s anterior): R$ ${valorBrutoEquivalente}\n- Valor Bruto Calculado para a Cota Atual: R$ ${valorBrutoResultado}\n- Total de Dedu√ß√µes (PASEP, Sa√∫de, FUNDEB, etc.): R$ ${totalDeducoes}\n- Previs√£o L√≠quida para o munic√≠pio: R$ ${previsaoLiquida}\n\nCom base nesses dados, forne√ßa uma an√°lise concisa em um √∫nico par√°grafo (m√°ximo de 3-4 frases). A an√°lise deve ser profissional, objetiva e √∫til para um gestor municipal. Compare brevemente o valor bruto atual com o do m√™s anterior, se for relevante, e comente sobre o impacto das dedu√ß√µes no valor l√≠quido final. Finalize com uma recomenda√ß√£o pr√°tica ou ponto de aten√ß√£o para a gest√£o financeira.`;
            callGeminiApi(prompt, true);
        }

        function analisarHistoricoComIA() {
            const historico = JSON.parse(localStorage.getItem('fpmHistorico')) || [];
            if (historico.length < 2) {
                mostrarModal('√â necess√°rio ter pelo menos dois registros no hist√≥rico para gerar uma an√°lise de tend√™ncias.');
                return;
            }
             if (GEMINI_API_KEY === "COLE_SUA_CHAVE_API_AQUI") {
                 mostrarModal('Por favor, adicione sua chave da API do Google Gemini no c√≥digo para usar esta funcionalidade.');
                 return;
            }
            mostrarModal(`<div class="spinner" style="margin: 0 auto 15px;"></div>Analisando o hist√≥rico... Por favor, aguarde.`);
            el('modal-botoes').style.display = 'none';

            const historicoFormatado = historico.slice(0, 10).reverse().map(item => `- Cota ${item.cota}/${item.mes}/${item.ano}: Valor L√≠quido R$ ${item.previsaoLiquida}`).join('\n');
            const prompt = `Aja como um analista de dados financeiros especializado em finan√ßas municipais. Analise os seguintes dados hist√≥ricos de repasses l√≠quidos do FPM para a prefeitura de Garanhuns:\n${historicoFormatado}\n\nCom base exclusivamente nesses dados, identifique a principal tend√™ncia (crescimento, queda ou estabilidade) dos valores l√≠quidos. Forne√ßa um resumo executivo de uma frase. Depois, apresente 2 ou 3 observa√ß√µes principais em formato de lista, usando "‚Ä¢ " para cada ponto. Mantenha a an√°lise curta, objetiva e focada nos dados fornecidos.`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) })
            .then(response => response.json())
            .then(result => {
                const candidate = result.candidates?.[0];
                const modalMsg = el('modal-mensagem');
                const modalBtns = el('modal-botoes');
                modalBtns.style.display = 'block';
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const analysis = candidate.content.parts[0].text.replace(/\n/g, '<br>').replace(/‚Ä¢ /g, '<br>‚Ä¢ ');
                    modalMsg.innerHTML = `<strong>An√°lise de Tend√™ncias do Hist√≥rico ‚ú®</strong><br><br>${analysis}`;
                } else {
                    modalMsg.textContent = 'N√£o foi poss√≠vel gerar a an√°lise do hist√≥rico. Tente novamente.';
                }
                modalBtns.innerHTML = '<button id="modal-btn-ok" class="download-btn">FECHAR</button>';
                el('modal-btn-ok').onclick = fecharModal;
            })
            .catch(error => {
                el('modal-mensagem').textContent = 'Ocorreu um erro ao conectar com o servi√ßo de IA. Verifique sua conex√£o e tente novamente.';
            });
        }

        // --- C√ìDIGO DO HIST√ìRICO E PREENCHIMENTO AUTOM√ÅTICO ---
        const valoresBrutosPrimeiraCota = JSON.parse(localStorage.getItem('fpmValoresBrutos')) || {};

        function salvarNoHistorico() {
            const cotaNum = val('cotaNumero');
            const cotaM = val('cotaMes');
            const cotaA = val('cotaAno');
            if (!cotaNum || !cotaM || !cotaA || cotaNum === '00' || cotaM === '00' || cotaA === '00') {
                mostrarModal('Por favor, preencha Cota, M√™s e Ano antes de salvar.');
                return;
            }
            const calculo = { id: Date.now(), cota: cotaNum, mes: cotaM, ano: cotaA, valorBrutoAnterior: val('valorBrutoAnterior'), multiplicador: val('multiplicador'), valorBrutoResultado: el('resultadoMultiplicacao').textContent, totalDeducoes: el('totalDeducoes').textContent, previsaoLiquida: el('previsaoLiquida').textContent };
            if (parseInt(cotaNum, 10) === 1) {
                valoresBrutosPrimeiraCota[cotaM] = val('valorBrutoAnterior');
                localStorage.setItem('fpmValoresBrutos', JSON.stringify(valoresBrutosPrimeiraCota));
            }
            const historico = JSON.parse(localStorage.getItem('fpmHistorico')) || [];
            historico.unshift(calculo);
            localStorage.setItem('fpmHistorico', JSON.stringify(historico));
            carregarHistorico();
            mostrarModal('C√°lculo salvo no hist√≥rico com sucesso!');
        }

        function carregarHistorico() {
            const historico = JSON.parse(localStorage.getItem('fpmHistorico')) || [];
            const container = el('historico-conteudo');
            const analiseContainer = el('analise-historico-container');
            const chartsContainer = el('graficos-historico-container');

            if (graficoBrutoHistorico) graficoBrutoHistorico.destroy();
            if (graficoDeducoesHistorico) graficoDeducoesHistorico.destroy();
            if (graficoLiquidoHistorico) graficoLiquidoHistorico.destroy();

            if (historico.length === 0) {
                container.innerHTML = '<p>Nenhum c√°lculo salvo ainda.</p>';
                analiseContainer.innerHTML = '';
                chartsContainer.style.display = 'none';
                return;
            }
            
            chartsContainer.style.display = 'grid';

            if (historico.length >= 2) {
                 analiseContainer.innerHTML = `<button onclick="analisarHistoricoComIA()" class="download-btn" style="width: 100%;">‚ú® ANALISAR TEND√äNCIAS COM IA</button>`;
            } else {
                 analiseContainer.innerHTML = '';
            }
            
            let html = `<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background-color: #4A2A20; color: #D9C6A5;"><th style="padding: 8px; border: 1px solid #000;">Cota/M√™s/Ano</th><th style="padding: 8px; border: 1px solid #000;">Valor Bruto (Resultado)</th><th style="padding: 8px; border: 1px solid #000;">Total Dedu√ß√µes</th><th style="padding: 8px; border: 1px solid #000;">Previs√£o L√≠quida</th></tr></thead><tbody>`;
            historico.forEach(item => {
                html += `<tr style="background-color: #fff; border-bottom: 1px solid #ccc;"><td style="padding: 8px; border: 1px solid #000; text-align: center;">${item.cota}/${item.mes}/${item.ano}</td><td style="padding: 8px; border: 1px solid #000; text-align: right;">R$ ${item.valorBrutoResultado}</td><td style="padding: 8px; border: 1px solid #000; text-align: right;">R$ ${item.totalDeducoes}</td><td style="padding: 8px; border: 1px solid #000; text-align: right;">R$ ${item.previsaoLiquida}</td></tr>`;
            });
            container.innerHTML = html + '</tbody></table>';

            // Chart Data Preparation
            const historicoReverso = [...historico].reverse(); 
            const labels = historicoReverso.map(item => `${item.cota}/${item.mes}/${item.ano}`);
            const dataBruto = historicoReverso.map(item => parseBR(item.valorBrutoResultado));
            const dataDeducoes = historicoReverso.map(item => parseBR(item.totalDeducoes));
            const dataLiquido = historicoReverso.map(item => parseBR(item.previsaoLiquida));

            // Chart 1: Valor Bruto
            graficoBrutoHistorico = new Chart(el('grafico-bruto-historico').getContext('2d'), {
                type: 'line',
                data: { labels, datasets: [{ label: 'Valor Bruto (R$)', data: dataBruto, borderColor: '#4A2A20', backgroundColor: 'rgba(74, 42, 32, 0.1)', fill: true, tension: 0.1 }] },
                options: { responsive: true, plugins: { title: { display: true, text: 'Evolu√ß√£o do Valor Bruto' }, legend: { display: false } } }
            });

            // Chart 2: Total Dedu√ß√µes
            graficoDeducoesHistorico = new Chart(el('grafico-deducoes-historico').getContext('2d'), {
                type: 'line',
                data: { labels, datasets: [{ label: 'Total Dedu√ß√µes (R$)', data: dataDeducoes, borderColor: '#8C2D2D', backgroundColor: 'rgba(140, 45, 45, 0.1)', fill: true, tension: 0.1 }] },
                options: { responsive: true, plugins: { title: { display: true, text: 'Evolu√ß√£o das Dedu√ß√µes' }, legend: { display: false } } }
            });

            // Chart 3: Previs√£o L√≠quida
            graficoLiquidoHistorico = new Chart(el('grafico-liquido-historico').getContext('2d'), {
                type: 'line',
                data: { labels, datasets: [{ label: 'Previs√£o L√≠quida (R$)', data: dataLiquido, borderColor: '#00A8A8', backgroundColor: 'rgba(0, 168, 168, 0.1)', fill: true, tension: 0.1 }] },
                options: { responsive: true, plugins: { title: { display: true, text: 'Evolu√ß√£o da Previs√£o L√≠quida' }, legend: { display: false } } }
            });
        }

        function limparHistorico() {
            mostrarModal('Tem certeza que deseja limpar todo o hist√≥rico?', 'confirm', () => {
                localStorage.removeItem('fpmHistorico');
                localStorage.removeItem('fpmValoresBrutos');
                Object.keys(valoresBrutosPrimeiraCota).forEach(key => delete valoresBrutosPrimeiraCota[key]);
                carregarHistorico();
            });
        }

        function verificarPreenchimentoAutomatico() {
            const cotaNum = parseInt(val('cotaNumero'), 10);
            const cotaM = val('cotaMes');
            if ((cotaNum === 2 || cotaNum === 3) && valoresBrutosPrimeiraCota[cotaM]) {
                const valorSalvo = valoresBrutosPrimeiraCota[cotaM];
                el('valorBrutoAnterior').value = valorSalvo;
                calc();
            }
        }
        
        // --- C√ìDIGO DA CALCULADORA ---
        const parseBR = s => parseFloat(String(s).replace(/\./g, '').replace(',', '.')) || 0;
        const fmt = n => new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(n);

        const ctx = el('grafico').getContext('2d');
        const grafico = new Chart(ctx, { type: 'bar', data: { labels: [''], datasets: [{ label: 'Cota m√™s anterior - Valor bruto', data: [0], backgroundColor: 'rgba(204, 255, 204, 1)', borderColor: 'rgba(180, 150, 100, 1)', borderWidth: 1 }, { label: 'Cota m√™s atual - Valor Bruto', data: [0], backgroundColor: 'rgba(255, 255, 204, 1)', borderColor: 'rgba(180, 150, 100, 1)', borderWidth: 1 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true, title: { display: true, text: 'Valor (R$)' } } } } });

        function atualizarGrafico(br, bev) {
            grafico.data.datasets[1].data = [br];
            grafico.data.datasets[0].data = [bev];
            grafico.update();
        }

        function calc() {
            const vb = parseBR(val('valorBrutoAnterior'));
            const m = parseFloat(val('multiplicador')) || 0;
            const r = vb * m;
            el('resultadoMultiplicacao').textContent = fmt(r);
            calcDeductions(r);
            atualizarGrafico(r, parseBR(val('valorBrutoEquivalente')));
        }

        function calcDeductions(br) {
            const p = br * 0.01;
            const s = br * 0.15;
            const f = br * 0.20;
            const rfb = parseBR(val('parcelamentoRfb'));
            const tot = p + s + f + rfb;
            el('deducaoPasep').textContent = fmt(p);
            el('deducaoSaude').textContent = fmt(s);
            el('deducaoFundeb').textContent = fmt(f);
            el('totalDeducoes').textContent = fmt(tot);
            el('previsaoLiquida').textContent = fmt(br - tot);
        }

        function updateRatio() {
            const l = parseBR(val('valorLiquidoAnterior'));
            const b = parseBR(val('valorBrutoEquivalente'));
            el('pesoPercentualFormatted').textContent = b ? ((l / b) * 100).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '%' : '0,00%';
            calc();
        }

        el('cotaNumero').addEventListener('input', verificarPreenchimentoAutomatico);
        el('cotaMes').addEventListener('input', verificarPreenchimentoAutomatico);

        el('multiplicador').addEventListener('input', e => {
            let raw = e.target.value.replace(/\D/g, '');
            if (!raw) raw = '0';
            const num = parseFloat(raw) / 10000;
            e.target.value = num.toFixed(4);
            calc();
        });

        el('multiplicador').addEventListener('blur', e => {
            const num = parseFloat(e.target.value);
            e.target.value = isNaN(num) ? '0.0000' : num.toFixed(4);
            calc();
        });

        ['valorBrutoAnterior', 'valorLiquidoAnterior', 'valorBrutoEquivalente', 'parcelamentoRfb'].forEach(id => {
            el(id).addEventListener('input', e => {
                let v = e.target.value.replace(/\D/g, '');
                v = (parseInt(v || 0) / 100).toFixed(2);
                e.target.value = parseFloat(v).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                if (id === 'valorBrutoAnterior') calc();
                else if (id === 'valorLiquidoAnterior' || id === 'valorBrutoEquivalente') updateRatio();
                else if (id === 'parcelamentoRfb') {
                    if (el('resultadoMultiplicacao').textContent !== '-') {
                       calcDeductions(parseBR(el('resultadoMultiplicacao').textContent));
                    }
                }
            });
        });

        function atualizarDataHora() {
            const now = new Date().toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
            el('dataHoraTela').textContent = 'üìÖ ' + now;
            el('dataHoraPdf').textContent = now;
        }

        function baixarPNG() {
            const elemento = document.querySelector('.container');
            const nomeArquivo = `FPM_${val('cotaNumero')||'X'}_${val('cotaMes')||'00'}.png`;
            html2canvas(elemento, { scale: 3, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = nomeArquivo;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        // --- INICIALIZA√á√ÉO ---
        function inicializar() {
            atualizarDataHora();
            setInterval(atualizarDataHora, 60000);
            el('cotaAno').value = new Date().getFullYear().toString().slice(-2);
            carregarHistorico();
            updateRatio();
        }

        inicializar();

    </script>
</body>
</html>

